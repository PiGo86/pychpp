image: "python:3.8"

before_script:
  - echo PYCHPP_CONSUMER_KEY=$PYCHPP_CONSUMER_KEY >> .env
  - echo PYCHPP_CONSUMER_SECRET=$PYCHPP_CONSUMER_SECRET >> .env
  - echo PYCHPP_ACCESS_TOKEN_KEY=$PYCHPP_ACCESS_TOKEN_KEY >> .env
  - echo PYCHPP_ACCESS_TOKEN_SECRET=$PYCHPP_ACCESS_TOKEN_SECRET >> .env
  - echo PYCHPP_SCOPE=$PYCHPP_SCOPE >> .env
  - pip install poetry
  - poetry config virtualenvs.create false
  - poetry install

stages:
  - test
  - deploy

style:
  stage: test
  script: poetry run flake8

test:
  stage: test
  script: poetry run pytest

deploy:
  stage: deploy
  only: [master]
  id_tokens:
    PYPI_ID_TOKEN:
      aud: pypi
  script:
    - pip install id
    - oidc_token=$(python -m id PYPI)
    - resp=$(curl -X POST https://pypi.org/_/oidc/mint-token -d "{\"token\":\"${oidc_token}\"}")
    - api_token=$(jq --raw-output '.token' <<< "${resp}")
    - poetry publish --build -u __token__ -p "${api_token}"